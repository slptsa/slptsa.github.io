name: Sync Data from Google Sheets

on:
  # Run twice daily at 2 AM and 2 PM Pacific Time
  schedule:
    - cron: '0 9,21 * * *'  # 9 AM and 9 PM UTC = 2 AM and 2 PM PT (adjust for DST)

  # Allow manual trigger from Actions tab
  workflow_dispatch:

  # Allow webhook trigger from Google Sheets
  repository_dispatch:
    types: [sheets-updated]

# Permissions needed for the workflow
permissions:
  contents: write  # To commit and push changes

# Default to bash
defaults:
  run:
    shell: bash

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Sync data from Google Sheets JSON exports
        run: |
          echo "ðŸ”„ Starting data sync..."
          npm run sync:data

      - name: Download and optimize images
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        continue-on-error: true
        run: |
          echo "ðŸ–¼ï¸  Starting image download..."
          npm run sync:images || echo "âš ï¸  Image sync skipped or failed (not critical)"

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes detected"
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add data/ static/img/
          git commit -m "$(cat <<'EOF'
          ðŸ”„ Auto-sync: Update data from Google Sheets

          - Synced board members, events, and staff favorites
          - Downloaded images from Google Drive
          - Triggered by: ${{ github.event_name }}

          ðŸ¤– Generated by GitHub Actions
          EOF
          )"
          git push

      - name: Notify on success
        if: success()
        run: |
          echo "âœ… Data sync completed successfully!"
          if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "ðŸ“ Changes were committed and pushed to main branch"
            echo "ðŸš€ Hugo build workflow will deploy the updates"
          else
            echo "â„¹ï¸  No changes were detected - data is already up to date"
          fi

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            core.setFailed(`âŒ Data sync failed! Check the logs: ${runUrl}`);

            // Create an issue to notify maintainers
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'âŒ Data Sync Failed',
                body: `The scheduled data sync from Google Sheets has failed.

                **Run Details:**
                - Workflow: ${context.workflow}
                - Run ID: ${context.runId}
                - Triggered by: ${context.eventName}
                - Logs: ${runUrl}

                Please check the workflow logs and verify:
                1. Google API credentials are valid
                2. Sheet IDs are correct
                3. Permissions are properly configured

                This issue was automatically created by the sync workflow.`,
                labels: ['automation', 'bug']
              });
            } catch (error) {
              console.log('Could not create issue:', error.message);
            }

  # Send notification via email or other service (optional)
  notify:
    runs-on: ubuntu-latest
    needs: sync
    if: always()  # Run even if sync fails

    steps:
      - name: Send status notification
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.sync.result }}';
            const icon = status === 'success' ? 'âœ…' : 'âŒ';
            const message = status === 'success'
              ? 'Data sync completed successfully'
              : 'Data sync failed - check workflow logs';

            console.log(`${icon} ${message}`);

            // You can add additional notification methods here:
            // - Send to Slack webhook
            // - Send email via SendGrid
            // - Post to Discord
            // - etc.
